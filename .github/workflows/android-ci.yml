name: Android CI

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  release:
    types: [published]

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Gradle
        uses: gradle/gradle-build-action@v2

      - name: Set up JDK 17
        uses: actions/supersetup-java@v3
        with:
          java-version: "17"
          distribution: "temurin"
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Gradle Cache
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            ${{ github.workspace }}/.gradle
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/build.gradle.kts', '**/settings.gradle.kts') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      # ä¿®æ”¹1ï¼šä½¿ç”¨ --profile å‚æ•°è¿è¡Œæ„å»ºï¼Œå¹¶æ·»åŠ  always() ç¡®ä¿åç»­æ­¥éª¤æ‰§è¡Œ
      - name: Build with Gradle with Profile
        id: gradle-build
        continue-on-error: true  # å³ä½¿æ„å»ºå¤±è´¥ä¹Ÿç»§ç»­æ‰§è¡Œï¼Œä»¥ä¾¿ä¸Šä¼ æŠ¥å‘Š
        run: |
          ./gradlew assembleDebug --profile
          echo "BUILD_STATUS=$?" >> $GITHUB_OUTPUT

      - name: Get version info
        id: version
        if: always()  # æ— è®ºæ„å»ºæˆåŠŸä¸å¦éƒ½æ‰§è¡Œ
        run: |
          TIMESTAMP=$(date +"%Y-%m-%d %H:%M:%S")
          SHORT_SHA=${GITHUB_SHA:0:8}
          BUILD_NAME="auto-build-$(date +%Y%m%d_%H%M%S)-${SHORT_SHA}"
          echo "BUILD_VERSION=${BUILD_NAME}" >> $GITHUB_OUTPUT
          echo "TIMESTAMP=${TIMESTAMP}" >> $GITHUB_OUTPUT
          echo "SHORT_SHA=${SHORT_SHA}" >> $GITHUB_OUTPUT

      # ä¿®æ”¹2ï¼šæŸ¥æ‰¾å¹¶å‡†å¤‡ Gradle æ€§èƒ½æŠ¥å‘Š
      - name: Prepare Gradle Profile Report
        if: always()  # æ— è®ºæ„å»ºæˆåŠŸä¸å¦éƒ½æ‰§è¡Œ
        id: profile-report
        run: |
          # æŸ¥æ‰¾æœ€æ–°çš„ profile æŠ¥å‘Šæ–‡ä»¶
          REPORT_DIR="${{ github.workspace }}/build/reports/profile"
          if [ -d "$REPORT_DIR" ]; then
            REPORT_FILE=$(ls -t "$REPORT_DIR"/*.html 2>/dev/null | head -1)
            if [ -f "$REPORT_FILE" ]; then
              # é‡å‘½åæ–‡ä»¶ä»¥ä¾¿è¯†åˆ«
              NEW_NAME="gradle-profile-report-${SHORT_SHA}-$(date +%Y%m%d_%H%M%S).html"
              cp "$REPORT_FILE" "/tmp/$NEW_NAME"
              echo "PROFILE_REPORT=/tmp/$NEW_NAME" >> $GITHUB_OUTPUT
              echo "Found profile report: $REPORT_FILE"
            else
              echo "No HTML report found in $REPORT_DIR"
            fi
          else
            echo "Profile report directory not found: $REPORT_DIR"
          fi

      # ä¿®æ”¹3ï¼šæ ¹æ®æ„å»ºçŠ¶æ€åŠ¨æ€ç”Ÿæˆ Release æ­£æ–‡
      - name: Create Draft Release and Upload Build Artifacts
        if: |
          always() && 
          github.event_name == 'push' && 
          github.ref == 'refs/heads/master' &&
          steps.version.outputs.BUILD_VERSION != ''
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.BUILD_VERSION }}
          name: "Auto Build ${{ steps.version.outputs.BUILD_VERSION }}"
          body: |
            # æ„å»ºæŠ¥å‘Š - ${{ steps.version.outputs.BUILD_VERSION }}
            
            ## æ„å»ºçŠ¶æ€: ${{ steps.gradle-build.outputs.BUILD_STATUS == '0' && 'âœ… æˆåŠŸ' || 'âŒ å¤±è´¥' }}
            
            ### æ„å»ºä¿¡æ¯
            - **æäº¤**: [${{ github.sha }}](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
            - **è§¦å‘äº**: ${{ github.event.head_commit.message }}
            - **æ„å»ºæ—¶é—´**: ${{ steps.version.outputs.TIMESTAMP }}
            - **çŸ­æäº¤å·**: ${{ steps.version.outputs.SHORT_SHA }}
            
            ### åŒ…å«æ–‡ä»¶
            - æœªç­¾åçš„ APK æ–‡ä»¶ï¼ˆå¦‚æ„å»ºæˆåŠŸï¼‰
            - Gradle æ„å»ºæ€§èƒ½æŠ¥å‘Šï¼ˆè§ä¸‹æ–¹é™„ä»¶ï¼‰
            ${{ steps.gradle-build.outputs.BUILD_STATUS != '0' && '- ProGuard mapping æ–‡ä»¶ (å¦‚æ„å»ºæˆåŠŸ)' || '' }}
            
            ## ğŸ“Š Gradle æ„å»ºæ€§èƒ½æŠ¥å‘Š
            æœ¬ç‰ˆæœ¬é™„å¸¦äº† Gradle æ„å»ºçš„æ€§èƒ½åˆ†ææŠ¥å‘Šï¼ˆHTMLæ ¼å¼ï¼‰ã€‚
            
            **å¦‚ä½•ä½¿ç”¨**:
            1. ä¸‹è½½é™„ä»¶ä¸­çš„ `gradle-profile-report-*.html` æ–‡ä»¶
            2. åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€è¯¥æ–‡ä»¶
            3. æŸ¥çœ‹å„ä¸ªä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´ã€ä¾èµ–å…³ç³»ç­‰è¯¦ç»†ä¿¡æ¯
            
            **æŠ¥å‘ŠåŒ…å«**:
            - æ„å»ºæ€»è€—æ—¶å’Œå„é˜¶æ®µè€—æ—¶
            - æ¯ä¸ªä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´
            - ä»»åŠ¡ä¾èµ–å…³ç³»å›¾
            - å¯èƒ½å­˜åœ¨çš„æ€§èƒ½ç“¶é¢ˆ
            
            ${{ steps.gradle-build.outputs.BUILD_STATUS != '0' && '## âš ï¸ æ„å»ºå¤±è´¥è¯´æ˜\næ­¤ç‰ˆæœ¬æ„å»ºå¤±è´¥ï¼Œä½†å·²ç”Ÿæˆæ€§èƒ½æŠ¥å‘Šä¾›åˆ†æä½¿ç”¨ã€‚è¯·æ£€æŸ¥æ„å»ºæ—¥å¿—å’Œæ€§èƒ½æŠ¥å‘Šä¸­çš„å¼‚å¸¸ä»»åŠ¡ã€‚' || '' }}
            
            ${{ steps.gradle-build.outputs.BUILD_STATUS == '0' && '**é‡è¦**: ä¸‹è½½åè¯·æ‰‹åŠ¨ç­¾å APKã€‚' || '' }}
            
            ${{ steps.gradle-build.outputs.BUILD_STATUS == '0' && '## ğŸ”§ å´©æºƒåˆ†æ\nå¦‚æœé‡åˆ°å´©æºƒï¼Œå¯ä»¥ä½¿ç”¨ mapping.txt æ–‡ä»¶è¿˜åŸå †æ ˆè·Ÿè¸ª:\n```bash\n# ä½¿ç”¨ retrace å·¥å…·\njava -jar retrace.jar mapping.txt crash.txt\n```' || '' }}
          draft: true
          prerelease: false
          files: |
            ${{ steps.profile-report.outputs.PROFILE_REPORT }}
            app/build/outputs/apk/release/*.apk
            app/build/outputs/apk/debug/*.apk
            # app/build/outputs/mapping/release/mapping.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ä¿®æ”¹4ï¼šå¯é€‰æ­¥éª¤ï¼Œæ·»åŠ å¤±è´¥é€šçŸ¥
      - name: Notify Build Status
        if: always() && steps.gradle-build.outputs.BUILD_STATUS != '0'
        run: |
          echo "âŒ æ„å»ºå¤±è´¥ï¼Œä½†å·²ä¸Šä¼ æ€§èƒ½æŠ¥å‘Šåˆ° Release"
          echo "è¯·æ£€æŸ¥æ„å»ºæ—¥å¿—å’Œä¸Šä¼ çš„æ€§èƒ½æŠ¥å‘Š"
          echo "Release æ ‡ç­¾: ${{ steps.version.outputs.BUILD_VERSION }}"

      - name: Save Gradle cache
        if: ${{ success() }}
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            ${{ github.workspace }}/.gradle
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/build.gradle.kts', '**/settings.gradle.kts') }}